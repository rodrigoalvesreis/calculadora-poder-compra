
<div class="container">
  <h1 class="mb-4">{{ title }}</h1>

  <!-- Formulário -->
  <form [formGroup]="form" (ngSubmit)="onCalcular()" novalidate class="row g-3 align-items-center">
    <div class="mb-3 mb-md-0 col-12 col-md-5">
      <label for="rendaMensal" class="form-label">Renda mensal</label>
      <input
        id="rendaMensal"
        class="form-control"
        type="text"
        formControlName="rendaMensal"
        appCurrencyMask
        placeholder="0,00"
        inputmode="numeric"
        autocomplete="off"
        aria-label="Informe sua renda mensal"
      />
      <small class="form-text text-muted">Considere a renda total, sem descontos.</small>
      <small class="text-danger" *ngIf="form.controls.rendaMensal.invalid && form.controls.rendaMensal.touched">
        Informe um valor maior que zero.
      </small>
    </div>

    <div class="mb-3 mb-md-0 col-12 col-md-5">
      <label for="entrada" class="form-label">Entrada + FGTS</label>
      <input
        id="entrada"
        class="form-control"
        type="text"
        formControlName="entrada"
        appCurrencyMask
        placeholder="0,00"
        inputmode="numeric"
        autocomplete="off"
        aria-label="Informe o valor disponível para entrada"
      />
      <small class="form-text text-muted">Quanto você tem disponível para entrada.</small>
      <small class="text-danger" *ngIf="form.controls.entrada.invalid && form.controls.entrada.touched">
        Informe um valor maior que zero.
      </small>
    </div>

    <div class="col-12 col-md-2 d-flex align-items-center justify-content-end">
      <button type="submit" [disabled]="carregando" class="btn btn-primary">
        <span class="btn__label">{{ carregando ? 'Calculando...' : 'Calcular' }}</span>
        <span class="btn__spinner" *ngIf="carregando" aria-hidden="true"></span>
      </button>
    </div>

    <div class="col-12" *ngIf="erro">
      <div class="alert alert-danger">{{ erro }}</div>
    </div>
  </form>

  <!-- Resultado -->
  <section class="resultado" *ngIf="resultado as r">
    <!-- Tabs -->
    <div class="tabs" role="tablist" aria-label="Abas de resultado">
      <button
        class="tabs__tab"
        [class.tabs__tab--active]="activeTab === 'potencial'"
        (click)="activeTab = 'potencial'"
        role="tab"
        [attr.aria-selected]="activeTab === 'potencial'"
      >
        Potencial
      </button>
      <button
        class="tabs__tab"
        [class.tabs__tab--active]="activeTab === 'renda'"
        (click)="activeTab = 'renda'"
        role="tab"
        [attr.aria-selected]="activeTab === 'renda'"
      >
        Máximo possível para a renda
      </button>
    </div>

    <!-- Painel: Potencial -->
    <div
      class="panel text-start text-md-center"
      *ngIf="activeTab === 'potencial'"
      role="tabpanel"
      aria-label="Painel potencial"
    >
      <p class="panel__subtitle">Seu potencial de compra é de um imóvel de até</p>
      <p class="panel__value">
        {{ formatBRL(r.valorImovel) }}<span class="asterisk">*</span>
      </p>
      <p class="panel__subnote">Prestação sugerida: {{ formatBRL(r.prestacaoSugerida || r.parcelaMaxima) }} *
      </p>
      <p class="panel__subnote">O valor é dividido em:</p>

      <!-- Barra segmentada (Entrada | Financiamento | Taxas) -->
      <div class="bar" aria-label="Distribuição de valores">
        <!-- Entrada atual = valorImovel - financiamentoFinal -->
        <span
          class="bar__segment bar__segment--entrada"
          [style.flex]="(r.valorImovel - r.financiamentoFinal)"
          title="Entrada"
        ></span>
        <span
          class="bar__segment bar__segment--financiamento"
          [style.flex]="r.financiamentoFinal"
          title="Valor a financiar"
        ></span>
        <span
          class="bar__segment bar__segment--taxas"
          [style.flex]="r.taxasEstimadas"
          title="ITBI e taxas"
        ></span>
      </div>

      <!-- Legenda -->
      <div class="legend row gy-2">
        <div class="legend__item col-12 col-md-4 d-flex align-items-center">
          <span class="legend__dot legend__dot--entrada me-2"></span>
          <div class="legend__text text-start">
            <div class="legend__label">Entrada</div>
            <div class="legend__value">{{ formatBRL(r.valorImovel - r.financiamentoFinal) }}</div>
          </div>
        </div>

        <div class="legend__item col-12 col-md-4 d-flex align-items-center">
          <span class="legend__dot legend__dot--financiamento me-2"></span>
          <div class="legend__text text-start">
            <div class="legend__label">Valor a financiar</div>
            <div class="legend__value">{{ formatBRL(r.financiamentoFinal) }}</div>
          </div>
        </div>

        <div class="legend__item col-12 col-md-4 d-flex align-items-center">
          <span class="legend__dot legend__dot--taxas me-2"></span>
          <div class="legend__text text-start">
            <div class="legend__label">
              ITBI e outras taxas
              <span class="legend__info" aria-label="Informações sobre taxas">i</span>
            </div>
            <div class="legend__value">{{ formatBRL(r.taxasEstimadas) }}</div>
          </div>
        </div>
      </div>

      <!-- Rodapé / Observação -->
      <div class="panel__footer">
        <small class="note">
          * Valor do imóvel sem considerar ITBI e outras taxas. Percentual estimado reaplicado ao valor do imóvel neste cenário.<br/>
          * A Prestação sugerida foi calculada de acordo com a tabela price, para uma taxa de {{ formatPct(params.taxaAnual) }} a.a. e prazo de {{ params.prazoAnos }} anos.
        </small>
      </div>
    </div>

    <!-- Painel: Máximo possível para a renda -->
    <div
      class="panel text-start text-md-center"
      *ngIf="activeTab === 'renda'"
      role="tabpanel"
      aria-label="Painel máximo possível para a renda"
    >
      <ng-container
        *ngIf="
          (r.entradaNecessariaMinima + r.financiamentoPorRenda) as valorImovelRenda;
          else rendaFallback
        "
      >
        <p class="panel__subtitle">Com entrada mínima suficiente, seu imóvel pode ser de até</p>
        <p class="panel__value">
          {{ formatBRL(valorImovelRenda) }}<span class="asterisk">*</span>
        </p>
       <p class="panel__subnote">Prestação sugerida (máximo pela renda): {{ formatBRL(r.parcelaMaxima) }} *
       </p>
        <p class="panel__subnote">O valor é dividido em:</p>

        <!-- Percentual de taxas reaproveitado do resultado atual -->
        <ng-container *ngIf="(r.taxasEstimadas / r.valorImovel) as taxaPerc">
          <ng-container *ngIf="(taxaPerc * valorImovelRenda) as taxasRenda">
            <!-- Barra segmentada (Entrada mínima | Financiamento por renda | Taxas) -->
            <div class="bar" aria-label="Distribuição de valores">
              <span
                class="bar__segment bar__segment--entrada"
                [style.flex]="r.entradaNecessariaMinima"
                title="Entrada mínima necessária"
              ></span>
              <span
                class="bar__segment bar__segment--financiamento"
                [style.flex]="r.financiamentoPorRenda"
                title="Valor a financiar pela renda"
              ></span>
              <span
                class="bar__segment bar__segment--taxas"
                [style.flex]="taxasRenda"
                title="ITBI e taxas"
              ></span>
            </div>

            <!-- Legenda -->
            <div class="legend row gy-2">
              <div class="legend__item col-12 col-md-4 d-flex align-items-center">
                <span class="legend__dot legend__dot--entrada me-2"></span>
                <div class="legend__text">
                  <div class="legend__label">Entrada mínima necessária</div>
                  <div class="legend__value">{{ formatBRL(r.entradaNecessariaMinima) }}</div>
                </div>
              </div>

              <div class="legend__item col-12 col-md-4 d-flex align-items-center">
                <span class="legend__dot legend__dot--financiamento me-2"></span>
                <div class="legend__text">
                  <div class="legend__label">Valor a financiar (pela renda)</div>
                  <div class="legend__value">{{ formatBRL(r.financiamentoPorRenda) }}</div>
                </div>
              </div>

              <div class="legend__item col-12 col-md-4 d-flex align-items-center">
                <span class="legend__dot legend__dot--taxas me-2"></span>
                <div class="legend__text">
                  <div class="legend__label">
                    ITBI e outras taxas
                    <span class="legend__info" aria-label="Informações sobre taxas">i</span>
                  </div>
                  <div class="legend__value">{{ formatBRL(taxasRenda) }}</div>
                </div>
              </div>
            </div>

            <!-- Rodapé / Observação -->
            <div class="panel__footer">
              <small class="note">
                * Valor do imóvel sem considerar ITBI e outras taxas. Percentual estimado reaplicado ao valor do imóvel neste cenário.<br/>
                * A Prestação sugerida foi calculada de acordo com a tabela price, para uma taxa de {{ formatPct(params.taxaAnual) }} a.a. e prazo de {{ params.prazoAnos }} anos.
              </small>
            </div>
          </ng-container>
        </ng-container>
      </ng-container>

      <ng-template #rendaFallback>
        <p class="panel__subtitle">Cenário pela renda</p>
        <p class="panel__value">{{ formatBRL(r.entradaNecessariaMinima + r.financiamentoPorRenda) }}</p>
      </ng-template>
    </div>
  </section>
</div>
